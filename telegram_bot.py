import os
import asyncio
import telegram
from datetime import datetime, timedelta
import google.generativeai as genai

# ==============================================================================
# ğŸ” í™˜ê²½ë³€ìˆ˜ ì„¤ì •
# ==============================================================================
try:
    GEMINI_KEY = os.environ["API_KEY"]          # ì œë¯¸ë‚˜ì´ í‚¤
    TELEGRAM_TOKEN = os.environ["TELEGRAM_TOKEN"] # í…”ë ˆê·¸ë¨ ë´‡ í† í°
    CHAT_ID = os.environ["TELEGRAM_CHAT_ID"]      # í…”ë ˆê·¸ë¨ ì±„íŒ…ë°© ID
except KeyError:
    print("âŒ í™˜ê²½ë³€ìˆ˜ ì˜¤ë¥˜: API_KEY, TELEGRAM_TOKEN, TELEGRAM_CHAT_IDë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    exit(1)

# ì œë¯¸ë‚˜ì´ ì„¤ì •
genai.configure(api_key=GEMINI_KEY)
model = genai.GenerativeModel('gemini-2.0-flash')

# ==============================================================================
# ğŸ§  AI: ì‹œì¥ ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± (í•µì‹¬ ë¡œì§)
# ==============================================================================
def generate_market_insight(messages_text):
    """
    ìˆ˜ì§‘ëœ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ë­‰ì¹˜ë¥¼ ë¶„ì„í•˜ì—¬ ê³ í€„ë¦¬í‹° ì‹œí™© ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
    """
    if not messages_text:
        return "âŒ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ
    today_str = (datetime.utcnow() + timedelta(hours=9)).strftime("%Y-%m-%d")
    
    # í”„ë¡¬í”„íŠ¸ (ìˆ˜ì„ íˆ¬ì ì „ëµê°€ í˜ë¥´ì†Œë‚˜)
    prompt = f"""
    ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ 'ìˆ˜ì„ íˆ¬ì ì „ëµê°€(Chief Market Strategist)'ì…ë‹ˆë‹¤.
    ì•„ë˜ ìˆ˜ì§‘ëœ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬, íˆ¬ììë“¤ì—ê²Œ **ì§„ì§œ ë„ì›€ì´ ë˜ëŠ” ì‹¬ì¸µ ì‹œì¥ ë³´ê³ ì„œ**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

    [ë¶„ì„ ëŒ€ìƒ ë°ì´í„°]
    {messages_text[:50000]} 

    [ğŸš¨ **í•µì‹¬ í•„í„°ë§ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)**]
    1. **ì¡ìŒ ì œê±° (Noise Filtering):**
       - **'íˆ¬ì ê²½ê³ /ì£¼ì˜ ì¢…ëª© ì§€ì •', 'ë‹¨ê¸° ê³¼ì—´', 'ê±°ë˜ ì •ì§€', 'ë‹¨ìˆœ ìœ ìƒì¦ì/CBë°œí–‰', 'ë‹¨ìˆœ ìì‚¬ì£¼ ì·¨ë“/ì²˜ë¶„' ë“± í–‰ì •ì /ê³µì‹œì„± ë‚´ìš©ì€ ì ˆëŒ€ ë©”ì¸ í…Œë§ˆë¡œ ì¡ì§€ ë§ˆì„¸ìš”.**
       - ê°œë³„ ì¡ì£¼(Small-cap)ì˜ ë‹¨ìˆœ ë“±ë½ì´ë‚˜ ì°Œë¼ì‹œëŠ” ë¬´ì‹œí•˜ì„¸ìš”.
    
    2. **í…Œë§ˆ ì„ ì • ê¸°ì¤€ (Priority):**
       - **1ìˆœìœ„:** ê±°ì‹œ ê²½ì œ(ê¸ˆë¦¬, í™˜ìœ¨, ìœ ê°€), ì§€ì •í•™ì  ì´ìŠˆ(ë¯¸êµ­ ëŒ€ì„ , ì „ìŸ ë“±).
       - **2ìˆœìœ„:** ì£¼ë„ ì„¹í„° íŠ¸ë Œë“œ (AI, ë°˜ë„ì²´, 2ì°¨ì „ì§€, ë°”ì´ì˜¤, ììœ¨ì£¼í–‰ ë“± ì‚°ì—… ë³€í™”).
       - **3ìˆœìœ„:** ì‹œì¥ì— í° ì¶©ê²©ì„ ì£¼ëŠ” ëŒ€í˜• ì•…ì¬/í˜¸ì¬.
    
    3. **í†µì°°ë ¥ (Insight):**
       - ë‹¨ìˆœ ì‚¬ì‹¤ ë‚˜ì—´ì´ ì•„ë‹ˆë¼, "ì´ê²ƒì´ ì‹œì¥ì— ì–´ë–¤ ì˜ë¯¸ì¸ê°€?"ë¥¼ í•´ì„í•˜ì„¸ìš”.
       - ì—¬ëŸ¬ ì±„ë„ì—ì„œ ê³µí†µì ìœ¼ë¡œ ì–¸ê¸‰í•˜ëŠ” 'ì‹œì¥ ì‹¬ë¦¬(Sentiment)'ë¥¼ ì½ì–´ë‚´ì„¸ìš”.

    [ì¶œë ¥ ì–‘ì‹ (Markdown)]
    # ğŸ“Š {today_str} í†µí•© ë§ˆì¼“ ì¸ì‚¬ì´íŠ¸

    ## ğŸ’¡ ì˜¤ëŠ˜ì˜ í•µì‹¬ ìš”ì•½ (3ì¤„)
    - (ì‹œì¥ ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” í•µì‹¬ ë¶„ìœ„ê¸° ìš”ì•½)

    ---

    ### í…Œë§ˆ 1: [í…Œë§ˆ ì œëª© (ì˜ˆ: AI ë°˜ë„ì²´ ì „ìŸ ì‹¬í™”)]
    - **ğŸ” í˜„í™©:** (íŒ©íŠ¸ ìœ„ì£¼ë¡œ 3~4ì¤„ ìš”ì•½)
    - **ğŸ—£ï¸ ì‹œì¥ ë°˜ì‘:** (íˆ¬ììë“¤ì˜ ë¶„ìœ„ê¸°, ìš°ë ¤ ë˜ëŠ” ê¸°ëŒ€ê°)
    - **ğŸ’¡ ì¸ì‚¬ì´íŠ¸:** (íˆ¬ì ì „ëµ, í–¥í›„ ì „ë§, ìˆ˜í˜œ ì˜ˆìƒ ì„¹í„° ë“± ê¹Šì´ ìˆëŠ” ë¶„ì„)

    ### í…Œë§ˆ 2: [í…Œë§ˆ ì œëª©]
    ... (ìœ„ì™€ ë™ì¼, ì´ 3~4ê°œ í…Œë§ˆ ì‘ì„±) ...

    ---
    ### ğŸ“ ê²°ë¡  ë° íˆ¬ì ì „ëµ
    (ì˜¤ëŠ˜ ì‹œì¥ì„ ëŒ€ì‘í•˜ëŠ” íˆ¬ììì˜ ìì„¸)
    """

    try:
        # Gemini Pro ëª¨ë¸ í˜¸ì¶œ
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"âŒ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: {str(e)}"

# ==============================================================================
# ğŸ“¤ í…”ë ˆê·¸ë¨ ì „ì†¡ í•¨ìˆ˜
# ==============================================================================
async def send_telegram_report(report_text):
    if not report_text: return
    
    bot = telegram.Bot(token=TELEGRAM_TOKEN)
    try:
        # ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¸¸ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ 4000ìì”© ëŠì–´ì„œ ì „ì†¡
        if len(report_text) > 4000:
            for i in range(0, len(report_text), 4000):
                await bot.send_message(chat_id=CHAT_ID, text=report_text[i:i+4000], parse_mode='Markdown')
        else:
            await bot.send_message(chat_id=CHAT_ID, text=report_text, parse_mode='Markdown')
            
        print("âœ… í…”ë ˆê·¸ë¨ ë¦¬í¬íŠ¸ ì „ì†¡ ì™„ë£Œ")
    except Exception as e:
        print(f"âŒ ì „ì†¡ ì‹¤íŒ¨: {e}")

# ==============================================================================
# ğŸš€ ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
# ==============================================================================
def main():
    print("ğŸ“¡ ë§ˆì¼“ ì¸ì‚¬ì´íŠ¸ ë´‡ ê°€ë™...")

    # ------------------------------------------------------------------
    # [1] ë°ì´í„° ìˆ˜ì§‘ ë‹¨ê³„
    # ------------------------------------------------------------------
    # âš ï¸ ì¤‘ìš”: ê¸°ì¡´ì— ì‚¬ìš©í•˜ì‹œë˜ 'í…”ë ˆê·¸ë¨ ì±„ë„ ë©”ì‹œì§€ ìˆ˜ì§‘ ì½”ë“œ'ê°€ ìˆë‹¤ë©´
    # ì•„ë˜ `all_messages` ë³€ìˆ˜ì— í…ìŠ¤íŠ¸ë¡œ í•©ì³ì„œ ë„£ì–´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤.
    # (í˜„ì¬ëŠ” ì½”ë“œê°€ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ë¬¸ìì—´ë¡œ ë‘¡ë‹ˆë‹¤.)
    
    all_messages = "" 
    
    # ì˜ˆì‹œ: ë§Œì•½ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ë‹¤ë©´?
    # with open("telegram_history.txt", "r", encoding="utf-8") as f:
    #     all_messages = f.read()

    # ------------------------------------------------------------------
    # [2] AI ë¶„ì„ ë‹¨ê³„
    # ------------------------------------------------------------------
    if all_messages:
        print("ğŸ§  AI ë¶„ì„ ì¤‘...")
        final_report = generate_market_insight(all_messages)
        print("ğŸ“ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!")
        
        # ------------------------------------------------------------------
        # [3] ì „ì†¡ ë‹¨ê³„
        # ------------------------------------------------------------------
        asyncio.run(send_telegram_report(final_report))
    else:
        print("âš ï¸ ë¶„ì„í•  ë©”ì‹œì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ìˆ˜ì§‘ ë¡œì§ í™•ì¸ í•„ìš”)")

if __name__ == "__main__":
    main()
